@page "/examples/basic/container-pivot"
@using SpawnDev.BlazorJS.JSObjects
@using SpawnDev.BlazorJS.PixiJS
@using static SpawnDev.BlazorJS.PixiJS.PIXI
@implements IDisposable

<h3>Container Pivot Example</h3>
<div @ref="containerElRef" style="width: 800px; height: 600px;"></div>

@code {
    [Inject] BlazorJSRuntime JS { get; set; } = default!;
    ElementReference? containerElRef;
    Application? app;
    Container? container;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Init();
        }
    }

    async Task Init()
    {
        app = new Application();
        await app.Init(new ApplicationOptions { Background = "#1099bb", ResizeTo = containerElRef });
        using var htmlElement = new HTMLElement(containerElRef!.Value);
        htmlElement!.AppendChild(app.Canvas);

        container = new Container();
        app.Stage.AddChild(container);

        var texture = await PIXI.Assets.Load<Texture>("https://pixijs.com/assets/bunny.png");

        // Create a 5x5 grid of bunnies
        for (int i = 0; i < 25; i++)
        {
            var bunny = new Sprite(texture);
            bunny.Anchor.Set(0.5f);
            bunny.X = (i % 5) * 40;
            bunny.Y = (float)Math.Floor((double)i / 5) * 40;
            container.AddChild(bunny);
        }

        // Move container to the center
        container.X = app.Screen.Width / 2;
        container.Y = app.Screen.Height / 2;

        // Center bunny sprite in local container coordinates
        // 5 bunnies * 40 width = 200 total width. Center is 100?
        // 0, 40, 80, 120, 160. Center is 80.
        container.Pivot.X = container.Width / 2;
        container.Pivot.Y = container.Height / 2;

        // Listen for frame updates
        app.Ticker.Add(OnTick);
    }

    void OnTick(Ticker ticker)
    {
        if (container != null)
        {
            container.Rotation -= 0.01f * ticker.DeltaTime;
        }
    }

    public void Dispose()
    {
        if (app != null)
        {
            app.Ticker.Remove(OnTick);
            app.Dispose();
        }
    }
}
