@page "/examples/events/dragging"
@using SpawnDev.BlazorJS.JSObjects
@using SpawnDev.BlazorJS.PixiJS
@using static SpawnDev.BlazorJS.PixiJS.PIXI
@implements IDisposable

<h3>Dragging Example</h3>
<div @ref="containerElRef" style="width: 800px; height: 600px;"></div>

@code {
    [Inject] BlazorJSRuntime JS { get; set; } = default!;
    ElementReference? containerElRef;
    Application? app;
    Texture? texture;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Init();
        }
    }

    async Task Init()
    {
        app = new Application();
        await app.Init(new ApplicationOptions { Background = "#1099bb", ResizeTo = containerElRef });
        using var htmlElement = new HTMLElement(containerElRef!.Value);
        htmlElement!.AppendChild(app!.Canvas);

        // Enable interactivity on the stage
        app!.Stage!.EventMode = "static";
        app!.Stage!.HitArea = app.Screen;

        texture = await PIXI.Assets.Load<Texture>("https://pixijs.com/assets/bunny.png");

        // Scale mode for pixelation
        // wrapper now has ScaleMode
        texture!.Source.ScaleMode = "nearest";

        // Use System.Random and System.Math
        var rand = new Random();
        for (int i = 0; i < 10; i++)
        {
            CreateBunny(
                (float)Math.Floor(rand.NextDouble() * app.Screen.Width),
                (float)Math.Floor(rand.NextDouble() * app.Screen.Height)
            );
        }
    }

    void CreateBunny(float x, float y)
    {
        var bunny = new Sprite(texture!);

        // Enable interactivity
        bunny.EventMode = "static";
        bunny.Cursor = "pointer";
        bunny.Anchor.Set(0.5f);
        bunny.Scale.Set(3);

        bunny.On("pointerdown", (FederatedPointerEvent e) => OnDragStart(bunny));

        bunny.X = x;
        bunny.Y = y;

        app!.Stage!.AddChild(bunny);
    }

    // Tracking state
    Sprite? draggingBunny = null;

    void OnDragStart(Sprite bunny)
    {
        // We need to listen to global move on the stage to handle fast movement
        draggingBunny = bunny;
        bunny.Alpha = 0.5f;

        using var stage = app!.Stage!;
        stage.OnPointerMove += OnDragMove;
        stage.OnPointerUp += OnDragEnd;
        stage.OnPointerUpOutside += OnDragEnd;
    }

    void OnDragEnd(FederatedPointerEvent e)
    {
        if (draggingBunny != null)
        {
            draggingBunny.Alpha = 1f;
            using var stage = app!.Stage!;
            stage.OnPointerMove -= OnDragMove;
            stage.OnPointerUp -= OnDragEnd;
            stage.OnPointerUpOutside -= OnDragEnd;
            draggingBunny = null;
        }
    }

    void OnDragMove(FederatedPointerEvent e)
    {
        if (draggingBunny != null)
        {
            var newPosition = e.Global;
            draggingBunny.X = newPosition.X;
            draggingBunny.Y = newPosition.Y;
        }
    }

    public void Dispose()
    {
        if (app != null)
        {
            app.Destroy();
            app.Dispose();
        }
    }
}
