@page "/examples/events/dragging"
@using SpawnDev.BlazorJS.JSObjects
@using SpawnDev.BlazorJS.PixiJS
@using static SpawnDev.BlazorJS.PixiJS.PIXI
@implements IDisposable

<h3>Dragging Example</h3>
<div @ref="containerElRef" style="width: 800px; height: 600px;"></div>

@code {
    [Inject] BlazorJSRuntime JS { get; set; } = default!;
    ElementReference? containerElRef;
    Application? app;
    Texture? texture;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Init();
        }
    }

    async Task Init()
    {
        app = new Application();
        await app.Init(new ApplicationOptions { Background = "#1099bb", ResizeTo = containerElRef });
        using var htmlElement = new HTMLElement(containerElRef!.Value);
        htmlElement!.AppendChild(app.Canvas);

        texture = await PIXI.Assets.Load<Texture>("https://pixijs.com/assets/bunny.png");

        // Scale mode for pixelation
        // wrapper now has ScaleMode
        texture.Source.ScaleMode = "nearest";

        // Use System.Random and System.Math
        var rand = new Random();
        for (int i = 0; i < 10; i++)
        {
            CreateBunny(
                (float)Math.Floor(rand.NextDouble() * app.Screen.Width),
                (float)Math.Floor(rand.NextDouble() * app.Screen.Height)
            );
        }
    }

    void CreateBunny(float x, float y)
    {
        var bunny = new Sprite(texture);

        // Enable interactivity
        bunny.EventMode = "static";
        bunny.Cursor = "pointer";
        bunny.Anchor.Set(0.5f);
        bunny.Scale.Set(3);

        bunny.On("pointerdown", (FederatedPointerEvent e) => OnDragStart(bunny));
        
        // Note: In PixiJS v8, listeners are attached to the stage or object. 
        // For global drag, usually we attach move/up to stage or window, 
        // but here we can attach to the bunny and use 'global' events or just standard ones if checking capture.
        // The official example attaches to the object.
        // We will store the drag state on the C# wrapper object isn't easy without a custom class, 
        // so we'll use a closure or a dictionary if needed. 
        // Actually, we can just use the lambda closure.
        
        // However, to mimic 'this.data' from JS, we need to capture the event data.
        // Let's use a simpler closure approach for this demo.
        
        bunny.X = x;
        bunny.Y = y;
        
        app!.Stage.AddChild(bunny);
    }
    
    // Tracking state
    Sprite? draggingBunny = null;
    FederatedPointerEvent? dragEvent = null;
    float dragOffsetX = 0;
    float dragOffsetY = 0;

    void OnDragStart(Sprite bunny)
    {
        // We need to listen to global move on the stage to handle fast movement
        draggingBunny = bunny;
        bunny.Alpha = 0.5f;
        
        app!.Stage.On<FederatedPointerEvent>("pointermove", OnDragMove);
        app!.Stage.On<FederatedPointerEvent>("pointerup", OnDragEnd);
        app!.Stage.On<FederatedPointerEvent>("pointerupoutside", OnDragEnd);
    }

    void OnDragEnd(FederatedPointerEvent e)
    {
        if (draggingBunny != null)
        {
            draggingBunny.Alpha = 1f;
            app!.Stage.Off<FederatedPointerEvent>("pointermove", OnDragMove);
            app!.Stage.Off<FederatedPointerEvent>("pointerup", OnDragEnd);
            app!.Stage.Off<FederatedPointerEvent>("pointerupoutside", OnDragEnd);
            draggingBunny = null;
        }
    }

    void OnDragMove(FederatedPointerEvent e)
    {
        if (draggingBunny != null)
        {
            var newPosition = e.Global;
            draggingBunny.X = newPosition.X;
            draggingBunny.Y = newPosition.Y;
        }
    }

    public void Dispose()
    {
        if (app != null)
        {
            app.Dispose();
        }
    }
}
